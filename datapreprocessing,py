import pandas as pd
import numpy as np
from sklearn.preprocessing import LabelEncoder, StandardScaler

print("Starting Data Preprocessing...")

# Load datasets
loan_df = pd.read_csv("Loan.csv")
borrower_df = pd.read_csv("Borrower.csv")

# Merge on correct column
df = pd.merge(loan_df, borrower_df, on="memberId", how="inner")
print("Datasets merged successfully!")

# Handle missing values
df.fillna(df.median(numeric_only=True), inplace=True)
df.fillna("Unknown", inplace=True)

# Outlier Treatment (IQR)
numeric_cols = df.select_dtypes(include=np.number).columns

for col in numeric_cols:
    Q1 = df[col].quantile(0.25)
    Q3 = df[col].quantile(0.75)
    IQR = Q3 - Q1

    lower = Q1 - 1.5 * IQR
    upper = Q3 + 1.5 * IQR

    df[col] = np.where(df[col] < lower, lower, df[col])
    df[col] = np.where(df[col] > upper, upper, df[col])

print("Outliers treated!")

# Encode categorical columns
label_encoder = LabelEncoder()
categorical_cols = df.select_dtypes(include="object").columns

for col in categorical_cols:
    df[col] = label_encoder.fit_transform(df[col])

print("Categorical encoding done!")

# Standardization
scaler = StandardScaler()
df[numeric_cols] = scaler.fit_transform(df[numeric_cols])

print("Feature scaling completed!")

# Save final dataset
df.to_csv("final_preprocessed_loan_data.csv", index=False)

print("Preprocessing Completed Successfully!")
print(df.head())

